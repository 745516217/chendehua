{include file=header.html}
<div class="layout archit2">
	{include file=member.menu2.html}
    <div class="m_con">
    	<div class="m_c_item">
        	<div class="m_c_tit o_C1_40">
            	{include file=message.common.html}
            </div>
            <div class="m_c_bx">
					<div style="height:13px; line-height:13px; overflow: hidden;"></div>
					<div class="input_box">
                     <form method="post" enctype="multipart/form-data" id="send_form" action="index.php?app=message&act=send" onsubmit="return post_yz_send();">
						<ul class="addressee cl">
							<li class="tit">收件人：</li>
							<li class="input send_select_user">
                            <input name = "this_to_user_name" value="{$smarty.get.to_user_name|escape}" type="text" class="text send_select_user" id="this_to_user_name" disabled="disabled" style="background:#fff;"/><input name = "to_user_name" value="{$smarty.get.to_user_id}" type="hidden" id="to_user_name">
                            </li>
							<li class="intro send_select_user" id="send_select_user">选择</li>
						</ul>
						<ul class="content_box cl">
							<li class="tit">内容：</li>
							<li class="input">
								<div class="cl"><textarea name="msg_content" cols="" rows="" id="msg_content" style="padding:10px;font-size:12px;line-height:20px;"></textarea><div id="msg_content_len" style="height:30px;"></div></div>
								<div class="cl"><input type="submit" class="button" value="{$lang.confirm_send}" /></div>
							</li>
						</ul>
                     </form>
					</div>
				</div>
        </div>
    </div>
</div>
<!--  粉丝选择框 -->
<div id="mask"></div>
<div id="select_box" style="display:none;">
    <div id='close'></div>
	<div class='message_selectCon'>
		<div class='message_select_follower'>
			<a href='javascript:void(0);'><img src='{res file=/images/message_select_follower.gif}'></a>
		</div>
	    <div class='message_follower' id="page_fanssend">
	    </div>
	</div>
</div>
<script>
	$("#this_to_user_name").change(function(){	//改变事件
		var this_to_user_name = $("#this_to_user_name").val();
		$("#to_user_name").val(this_to_user_name);
	});
	function post_yz_send(){			//提交表单判断
		var this_to_user_name = $("#this_to_user_name").val();
		var msg_content = removeBlank($("#msg_content").val());	//去除多余的空格
		if(this_to_user_name == 'undefined' || this_to_user_name == null || this_to_user_name == ''){
			alert("请选择收件人");
			return false;
		}
		if(msg_content == 'undefined' || msg_content == null || msg_content == '' || msg_content == ' '){
			alert("内容不能为空");
			return false;
		}
		return true;
	};
</script>
<script language="javascript" type="text/javascript" src="{lib file=fun_page_function.js}"></script>
<script>
var xianshi_data = new Array();		//定义一个存储的数组
var moren_to_id = "{$smarty.get.to_user_id}";	//如果从粉丝入口发私信
var moren_to_name = "{$smarty.get.to_user_name}";
if(moren_to_id != '' && moren_to_id != undefined && moren_to_id != null){	//从粉丝圈发送私信进入到这个页面的时候根据to_id，把uid加入到xianshi_data存储数组中
	var m_id = moren_to_id.split(",");
	var m_name = moren_to_name.split(",");
	for(var i = 0;i < m_id.length;i++){
		xianshi_data.push(m_id[i]+'|'+m_name[i]); 
	}
}
var shuju_data;	//显示当前分页的数据
var content_len = 200;//设置输入框字数

function ajaxData(ajaxurl) {	//分页AJAX
    $.ajax({
        type : "get",
        url : ajaxurl,
        beforeSend : function(XMLHttpRequest) {
        },
        success : function(data, textStatus) {

            data_to_view(data);
				for(var j=0;j <  shuju_data.length; j++){	//每次点击分页的时候根据xianshi_data数组中的元素，默认给当前页面的21个粉丝中已经选择的粉丝加上选择状态
                    var this_input =$("#message_follower_div_ul li").eq(j);
                    for(var k = 0;k < xianshi_data.length ; k++){
                        if(xianshi_data[k] ==  this_input.find("input").val()){
							this_input.find("em").attr("class","ismarked");

                        }
                    }
                }   
        },
        complete : function(XMLHttpRequest, textStatus) {
            completefunction();
        },
        error : function() {
            alert('请求服务器失败！');
        }
    });
}
function completefunction() {
        pageClick();

}
function pageClick() {
        /* ajax分页点击 */
        $('#fun_page a').click(function() {
            ajaxData($(this).attr("href"));
            return false;
        });
    }
function data_to_view(data){	//加载出来的视图
	var datas = eval("("+data+")");
	var fandata = datas.data;
	shuju_data = fandata;	//当前页面的数据
	var page_now = datas.page;
	var pages = datas.pageCount;
	var url = "{$site_url}/index.php?app=message&act=get_listfollower&page=";
	$("#page_fanssend").empty();//清空内容
	$("#page_fanssend").append("<div class='message_follower_div'><ul id='message_follower_div_ul'></ul></div>");
	for(var i = 0;i < fandata.length; i++){ 	//循环遍历粉丝，
		$("#message_follower_div_ul").append("<li><img src='"+fandata[i].portrait+"' title='" + fandata[i].user_name + "' width='80' height='80'><em class='nomarked'></em><input type='checkbox' name='uid' value='"+fandata[i].user_id+"|"+fandata[i].user_name+"' style='display:none;'></li>");
	}
	$("#page_fanssend").append("<div style='text-align:center;margin-top:17px;_margin-top:8px;'><a href='javascript:select_funs_uid();' class='upload' id='upload'>确定</a></div>");//加上确认选择框
	$("#message_follower_div_ul li").bind("click",function(){		//绑定click选项   通过是否存在数组中判断是否已经点击
		var _this =$(this);
		if(xianshi_data.length !='' && xianshi_data.length != undefined && xianshi_data.length !=null){	//如果数组不为空
			var is =1;	//判断标示符
			for(var i = 0;i < xianshi_data.length ; i++){	//遍历当前存储的数组
				if(xianshi_data[i] ==  _this.find("input").val()){	//如果当前点击的数据已经存在于数组中，这表示（取消）
					_this.find("em").attr("class","nomarked");	
					xianshi_data.splice(i,1);						//从第I个删除一个元素---即去掉数组当前点击元素的选中状态
					is = 0;
					break;
				}
				else{												//这表示（添加）
					_this.find("em").attr("class","ismarked");
					is = 1;
				}
			}
			if(is != 0){		//循环后为0，表示删除成功
				xianshi_data.push(_this.find("input").val());
			}
		}else{
			_this.find("em").attr("class","ismarked");
			xianshi_data.push(_this.find("input").val());
		}
	});																	//点击事件结束
	var pagestr = page_now_function(page_now,pages,url);	//分页开始
		var str ="";
		str = pages <=1 ? "" :  "<div id='fun_page' style='width:"+pagestr[5]+"px;'>" 
		            	    + pagestr[0] + pagestr[1] + pagestr[2] + pagestr[3] + pagestr[4]
		                    + "<span class='qingxuanze'>跳转到</span>"
		                    + "<input type='text' name='pageinput' id='pageinput' onkeyup='pageinput(this);'>"
		                    + "<input type='hidden' id='page_url' value="+url+">"
		                    + "<span onclick='pagesubmit("+pages+");' id='pagego' ></span>" //收藏使用pagesubmitss跳转
		                    + "</div>";
	$(".message_follower_div").after(str);	//分页结束
}

$(function(){
    $(".send_select_user").click(function(){		//点击选择按钮
		ajaxData("{$site_url}/index.php?app=message&act=get_listfollower");	//先加载粉丝数据一次
		openSend();			//调用显示图层函数
		return false;	
	});
	$("#msg_content").keyup(function(){	//获取内容的长度
		var this_len = parseInt(removeBlank($("#msg_content").val()).length);	//长度
		var sums = content_len - this_len;		//剩余的长度
		if(sums >= 0){					//输出
			$("#msg_content_len").html("<span style='color:green;'>还能输入"+sums+"个文字</span>");
		}else{
			 $("#msg_content_len").html("<span style='color:red;'>已经超出"+Math.abs(sums)+"个文字,超出的文字将被截取</span>");
		}
	});
});
function select_funs_uid(){	//选择粉丝
	var len = xianshi_data.length;
	var xianshi_name = ''; 
	var xianshi_uid = '';
	if(len>1){
		xianshi_name = xianshi_data[0].split("|")[1];
                xianshi_uid = xianshi_data[0].split("|")[0];
		for(var i=1;i<len;i++){
			xianshi_name = xianshi_name + ',' + xianshi_data[i].split("|")[1];
			xianshi_uid = xianshi_uid + ',' + xianshi_data[i].split("|")[0];
		}
	}else if(len == 1){
		xianshi_name = xianshi_data[0].split("|")[1];
		xianshi_uid = xianshi_data[0].split("|")[0];
	}else{
		xianshi_name = '';
		xianshi_uid = '';
	}
	$("input[name='to_user_name']").attr('value',xianshi_uid);      //赋值给to_user_name
	$("input[name='this_to_user_name']").attr('value',xianshi_name);        //赋值给this_to_user_name
	message_send_close();
}
function openSend(){	//弹出框
	//获取页面的高度和宽度
	var sWidth = document.body.scrollWidth;
	var sHeight = document.body.scrollHeight;
	//获取页面的可视区域高度和宽度
	var wHeight = document.documentElement.clientHeight;
	var oMask = document.getElementById("mask");
	oMask.style.height = sHeight + "px";
	oMask.style.width=sWidth + "px";
	//var oMessage_select = document.getElementById("message_select");
	var oSelect_div = document.getElementById("select_box");
	//设置登陆框的left和top
	var this_left = parseInt(sWidth/2) - 780/2;
	var this_top = parseInt(wHeight/2) - 508/2;
	this_left <=0 ? 0 : this_left;
	this_top <=0 ? 0 : this_top;
	oSelect_div.style.top = this_top + "px";
	oSelect_div.style.left = this_left + "px";
	oSelect_div.style.display = "block";
	oMask.style.display = "block";
	//点击关闭按钮
	var oClose=document.getElementById("close");
	//点击登陆框以外的区域也可以关闭登陆框
	oClose.onclick=function(){
		message_send_close();
	};
};
function message_send_close(){	//关闭弹出层
	var oMask = document.getElementById("mask");
	var oSelect_div = document.getElementById("select_box");
	oSelect_div.style.display = "none";
	oMask.style.display = "none";
}

function removeBlank(str){	//多个空格转化成一个空格

     str=str.replace(/(\s+$)|(^\s+)/g,"");
     str=str.replace(/\s+/g," ");

     return str;

}
</script>
{include file=footer.html}
